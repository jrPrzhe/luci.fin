# Безопасная миграция на новую БД в production

План безопасного переключения бэкенда на новую базу данных PostgreSQL (195.43.142.121) без потери данных и без поломки существующей логики.

## ⚠️ ВАЖНО: Перед началом

1. **Сделайте бэкап текущей production БД**
2. **Протестируйте на staging окружении** (если есть)
3. **Убедитесь, что новая БД настроена и доступна**
4. **Запланируйте деплой в период низкой нагрузки**

## Шаг 1: Подготовка новой БД

### 1.1. Проверка новой БД

Убедитесь, что новая БД готова:

```bash
# Проверка подключения
psql -h 195.43.142.121 -U finance_user -d finance_db -c "SELECT version();"

# Проверка таблиц
psql -h 195.43.142.121 -U finance_user -d finance_db -c "\dt"
```

### 1.2. Применение миграций на новой БД

```bash
# Локально с указанием DATABASE_URL
export DATABASE_URL=postgresql://finance_user:пароль@195.43.142.121:5432/finance_db
cd backend
python run_migrations.py
```

## Шаг 2: Миграция данных (если нужно)

### 2.1. Экспорт данных из старой БД

Если у вас есть данные в текущей production БД, экспортируйте их:

```bash
# Экспорт всех данных
pg_dump -h старый_хост -U старый_пользователь -d старая_бд > backup.sql

# Или только структура
pg_dump -h старый_хост -U старый_пользователь -d старая_бд --schema-only > schema.sql

# Или только данные
pg_dump -h старый_хост -U старый_пользователь -d старая_бд --data-only > data.sql
```

### 2.2. Импорт данных в новую БД

```bash
# Импорт структуры
psql -h 195.43.142.121 -U finance_user -d finance_db < schema.sql

# Импорт данных
psql -h 195.43.142.121 -U finance_user -d finance_db < data.sql
```

⚠️ **ВНИМАНИЕ:** Если структура уже создана миграциями, импортируйте только данные!

## Шаг 3: Безопасное переключение на Railway

### 3.1. Подготовка переменных окружения

В Railway добавьте новую переменную окружения (пока не меняйте старую):

1. Откройте ваш проект на Railway
2. Перейдите в **Variables**
3. Добавьте новую переменную:
   - **Name**: `DATABASE_URL_NEW`
   - **Value**: `postgresql://finance_user:пароль@195.43.142.121:5432/finance_db`

### 3.2. Тестирование на отдельном сервисе (рекомендуется)

Создайте тестовый сервис для проверки:

1. В Railway создайте **новый сервис** (не трогайте production)
2. Скопируйте все переменные окружения из production
3. Установите `DATABASE_URL` на новую БД
4. Задеплойте и протестируйте

### 3.3. Переключение production (после тестирования)

**Вариант A: Прямое переключение (если нет данных для миграции)**

1. Откройте production сервис на Railway
2. Перейдите в **Variables**
3. Измените `DATABASE_URL` на новую БД:
   ```
   postgresql://finance_user:пароль@195.43.142.121:5432/finance_db
   ```
4. Railway автоматически перезапустит сервис

**Вариант B: Постепенное переключение (если есть данные)**

1. Убедитесь, что данные мигрированы (Шаг 2)
2. Создайте бэкап старой БД
3. Переключите `DATABASE_URL` на новую БД
4. Мониторьте логи и ошибки
5. Если что-то пошло не так - быстро верните старую БД

## Шаг 4: Проверка после переключения

### 4.1. Проверка подключения

```bash
# Проверка через API
curl https://your-backend.railway.app/docs

# Проверка health endpoint (если есть)
curl https://your-backend.railway.app/health
```

### 4.2. Проверка данных

```bash
# Проверка пользователей
psql -h 195.43.142.121 -U finance_user -d finance_db -c "SELECT COUNT(*) FROM users;"

# Проверка транзакций
psql -h 195.43.142.121 -U finance_user -d finance_db -c "SELECT COUNT(*) FROM transactions;"
```

### 4.3. Функциональное тестирование

1. Попробуйте авторизоваться
2. Создайте тестовую транзакцию
3. Проверьте основные функции приложения

## Шаг 5: Откат (если что-то пошло не так)

Если возникли проблемы:

1. **Немедленно верните старую БД:**
   - В Railway → Variables
   - Измените `DATABASE_URL` обратно на старую БД
   - Railway перезапустит сервис

2. **Проверьте логи:**
   ```bash
   railway logs
   ```

3. **Исправьте проблемы** и повторите попытку

## Шаг 6: Очистка (после успешного переключения)

После успешного переключения и проверки:

1. Удалите старую БД (если не нужна)
2. Удалите переменную `DATABASE_URL_NEW` из Railway
3. Обновите документацию

## Чек-лист безопасного деплоя

- [ ] Бэкап текущей production БД создан
- [ ] Новая БД настроена и доступна
- [ ] Миграции применены на новой БД
- [ ] Данные мигрированы (если нужно)
- [ ] Протестировано на staging/тестовом сервисе
- [ ] Переменные окружения подготовлены
- [ ] План отката готов
- [ ] Команда уведомлена о деплое
- [ ] Деплой выполнен
- [ ] Проверка функциональности пройдена
- [ ] Мониторинг настроен

## Рекомендации

1. **Делайте деплой в период низкой нагрузки** (ночью или рано утром)
2. **Имейте план отката** - знайте, как быстро вернуться к старой БД
3. **Мониторьте логи** первые несколько часов после переключения
4. **Сохраните старую БД** минимум на неделю после переключения
5. **Уведомите пользователей** о возможных кратковременных перебоях

## Альтернативный подход: Blue-Green Deployment

Если у вас критически важное приложение:

1. Создайте **новый сервис** на Railway с новой БД
2. Настройте **балансировщик** или **переключение DNS**
3. Постепенно переключайте трафик на новый сервис
4. После проверки - остановите старый сервис

Это более безопасно, но требует дополнительной настройки.














