# Отладка ошибки 502 Bad Gateway

Ошибка 502 означает, что приложение не запустилось или упало при старте.

## Причины 502 ошибки

1. **Приложение не запустилось** - ошибка при старте
2. **Приложение упало** - краш при обработке запроса
3. **Проблема с подключением к БД** - не может подключиться к базе данных
4. **Ошибка в миграциях** - миграции не могут примениться
5. **Проблема с переменными окружения** - отсутствуют обязательные переменные

## Шаг 1: Проверка логов Railway

**Самое важное!** Откройте логи в Railway:

1. Зайдите на [railway.app](https://railway.app)
2. Откройте ваш проект
3. Откройте **Backend сервис**
4. Перейдите в **Logs** (или **Deployments** → выберите последний деплой → **View Logs**)

Ищите:
- ❌ Ошибки подключения к БД
- ❌ Ошибки миграций
- ❌ ImportError или ModuleNotFoundError
- ❌ Ошибки при старте приложения

## Шаг 2: Проверка переменных окружения

В Railway → Backend сервис → **Variables** проверьте:

### Обязательные переменные:
- ✅ `DATABASE_URL` - должен быть установлен на новую БД
- ✅ `SECRET_KEY` - должен быть установлен

### Формат DATABASE_URL:
```
postgresql://finance_user:пароль@195.43.142.121:5432/finance_db
```

## Шаг 3: Проверка подключения к БД

Проверьте, что новая БД доступна:

```bash
# Проверка подключения
psql -h 195.43.142.121 -U finance_user -d finance_db -c "SELECT version();"
```

Если не подключается - проблема в БД или файрволе.

## Шаг 4: Проверка миграций

Если миграции не применяются, приложение может не запуститься.

В логах Railway ищите строки:
- `Running database migrations...`
- `Database migrations applied successfully`
- Или ошибки миграций

## Шаг 5: Типичные проблемы и решения

### Проблема 1: Ошибка подключения к БД

**Симптомы в логах:**
```
OperationalError: could not connect to server
Connection refused
```

**Решение:**
1. Проверьте `DATABASE_URL` в Railway Variables
2. Проверьте доступность БД: `psql -h 195.43.142.121 ...`
3. Проверьте файрвол на сервере БД

### Проблема 2: Ошибка миграций

**Симптомы в логах:**
```
alembic.exc.CommandError
ProgrammingError
```

**Решение:**
1. Проверьте, что миграции применены локально
2. Примените миграции вручную через Railway CLI:
   ```bash
   railway run alembic upgrade head
   ```

### Проблема 3: Отсутствуют зависимости

**Симптомы в логах:**
```
ModuleNotFoundError: No module named '...'
ImportError: cannot import name '...'
```

**Решение:**
1. Проверьте `requirements.txt`
2. Убедитесь, что все зависимости указаны
3. Пересоберите проект на Railway

### Проблема 4: Ошибка кодировки (если еще не исправлено)

**Симптомы в логах:**
```
UnicodeEncodeError: 'ascii' codec can't encode
```

**Решение:**
- Убедитесь, что последний коммит с исправлением задеплоен
- Проверьте логи - должна быть строка о применении изменений

## Шаг 6: Ручная проверка через Railway CLI

Если есть доступ к Railway CLI:

```bash
# Установите Railway CLI
npm i -g @railway/cli

# Авторизуйтесь
railway login

# Подключитесь к проекту
railway link

# Проверьте логи
railway logs

# Попробуйте запустить команду в контейнере
railway run python -c "from app.core.config import settings; print(settings.DATABASE_URL[:50])"
```

## Шаг 7: Временное отключение автоматических миграций

Если проблема в миграциях, можно временно отключить их:

В Railway Variables добавьте:
```
SKIP_MIGRATIONS=true
```

Это отключит автоматическое применение миграций при старте.

## Шаг 8: Проверка health endpoint

После исправления проверьте:

```bash
curl https://your-backend.railway.app/docs
```

Должна открыться документация API.

## Что делать прямо сейчас

1. **Откройте логи Railway** - это самое важное!
2. **Скопируйте последние ошибки** из логов
3. **Проверьте DATABASE_URL** в Variables
4. **Проверьте доступность БД** с вашего компьютера

Пришлите логи из Railway - по ним можно точно определить проблему.






