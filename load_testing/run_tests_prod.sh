#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –¥–ª—è Production –æ–∫—Ä—É–∂–µ–Ω–∏—è
# Production Load Testing Script for Linux/Mac
# Usage: ./run_tests_prod.sh [scenario]

SCENARIO=${1:-light}
HOST=${LOCUST_HOST:-""}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è production URL
if [ -z "$HOST" ]; then
    echo "=========================================="
    echo "–û–®–ò–ë–ö–ê: Production URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    echo "=========================================="
    echo ""
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è LOCUST_HOST:"
    echo '  export LOCUST_HOST="https://api.yourdomain.com"'
    echo ""
    echo "–ò–ª–∏ —É–∫–∞–∂–∏—Ç–µ URL –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ:"
    echo '  LOCUST_HOST="https://api.yourdomain.com" ./run_tests_prod.sh light'
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ production URL
if [[ ! "$HOST" =~ ^https?:// ]]; then
    echo "=========================================="
    echo "–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http:// –∏–ª–∏ https://"
    echo "=========================================="
    exit 1
fi

# –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ production —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
echo ""
echo "=========================================="
echo "‚ö†Ô∏è  –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï PRODUCTION –û–ö–†–£–ñ–ï–ù–ò–Ø ‚ö†Ô∏è"
echo "=========================================="
echo ""
echo "–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ç–µ—Å—Ç –Ω–∞ PRODUCTION!"
echo ""
echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:"
echo "  ‚úì –ü–æ–ª—É—á–µ–Ω–æ –æ–¥–æ–±—Ä–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã"
echo "  ‚úì –ù–∞—Å—Ç—Ä–æ–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã"
echo "  ‚úì –î–æ—Å—Ç—É–ø–Ω—ã –ª–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"
echo "  ‚úì –ù–µ —á–∞—Å—ã –ø–∏–∫"
echo "  ‚úì –ï—Å—Ç—å –ø–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞"
echo ""
echo "Target: $HOST"
echo "–°—Ü–µ–Ω–∞—Ä–∏–π: $SCENARIO"
echo ""

# –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
if [ "$SCENARIO" = "stress" ] || [ "$SCENARIO" = "spike" ]; then
    echo "=========================================="
    echo "üö® –ê–ì–†–ï–°–°–ò–í–ù–´–ô –¢–ï–°–¢ üö®"
    echo "=========================================="
    echo ""
    echo "–í—ã –≤—ã–±—Ä–∞–ª–∏ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: $SCENARIO"
    echo "–≠—Ç–æ—Ç —Ç–µ—Å—Ç –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –≤—ã—Å–æ–∫—É—é –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ —Å–∏—Å—Ç–µ–º—É!"
    echo ""
    read -p "–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í–≤–µ–¥–∏—Ç–µ 'YES' –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è: " confirm
    if [ "$confirm" != "YES" ]; then
        echo "–¢–µ—Å—Ç –æ—Ç–º–µ–Ω–µ–Ω."
        exit 0
    fi
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ health endpoint –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–æ–º
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞..."
if curl -f -s --max-time 10 "$HOST/health" > /dev/null 2>&1; then
    echo "‚úì –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞ –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º."
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—à–∏–±–∫—É? (y/N): " continue_test
    if [ "$continue_test" != "y" ] && [ "$continue_test" != "Y" ]; then
        exit 1
    fi
fi

echo ""
echo "–ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥..."
echo "–ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Ç–º–µ–Ω—ã"
sleep 5

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤
mkdir -p reports

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è timestamp –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
REPORT_PREFIX="prod_${SCENARIO}_${TIMESTAMP}"

echo ""
echo "=========================================="
echo "–ó–∞–ø—É—Å–∫ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞"
echo "=========================================="
echo ""

case $SCENARIO in
    light)
        echo "–°—Ü–µ–Ω–∞—Ä–∏–π: –õ–µ–≥–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞"
        echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 10"
        echo "–°–∫–æ—Ä–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è: 1 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å/—Å–µ–∫"
        echo "–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 5 –º–∏–Ω—É—Ç"
        echo ""
        locust -f locustfile.py --host=$HOST --headless -u 10 -r 1 -t 5m --html "reports/${REPORT_PREFIX}.html" --csv "reports/$REPORT_PREFIX"
        ;;
    medium)
        echo "–°—Ü–µ–Ω–∞—Ä–∏–π: –°—Ä–µ–¥–Ω—è—è –Ω–∞–≥—Ä—É–∑–∫–∞"
        echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 50"
        echo "–°–∫–æ—Ä–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è: 5 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π/—Å–µ–∫"
        echo "–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 10 –º–∏–Ω—É—Ç"
        echo ""
        locust -f locustfile.py --host=$HOST --headless -u 50 -r 5 -t 10m --html "reports/${REPORT_PREFIX}.html" --csv "reports/$REPORT_PREFIX"
        ;;
    high)
        echo "–°—Ü–µ–Ω–∞—Ä–∏–π: –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞"
        echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 200"
        echo "–°–∫–æ—Ä–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è: 10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π/—Å–µ–∫"
        echo "–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 15 –º–∏–Ω—É—Ç"
        echo ""
        locust -f locustfile.py --host=$HOST --headless -u 200 -r 10 -t 15m --html "reports/${REPORT_PREFIX}.html" --csv "reports/$REPORT_PREFIX"
        ;;
    stress)
        echo "–°—Ü–µ–Ω–∞—Ä–∏–π: –°—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç"
        echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 500"
        echo "–°–∫–æ—Ä–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è: 20 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π/—Å–µ–∫"
        echo "–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 20 –º–∏–Ω—É—Ç"
        echo ""
        echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –æ—á–µ–Ω—å –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Ç–µ—Å—Ç!"
        echo ""
        locust -f locustfile.py --host=$HOST --headless -u 500 -r 20 -t 20m --html "reports/${REPORT_PREFIX}.html" --csv "reports/$REPORT_PREFIX"
        ;;
    spike)
        echo "–°—Ü–µ–Ω–∞—Ä–∏–π: –¢–µ—Å—Ç –Ω–∞ —Å–∫–∞—á–æ–∫ –Ω–∞–≥—Ä—É–∑–∫–∏"
        echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 100"
        echo "–°–∫–æ—Ä–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è: 100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π/—Å–µ–∫ (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ)"
        echo "–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 2 –º–∏–Ω—É—Ç—ã"
        echo ""
        echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –†–µ–∑–∫–∏–π —Å–∫–∞—á–æ–∫ –Ω–∞–≥—Ä—É–∑–∫–∏!"
        echo ""
        locust -f locustfile.py --host=$HOST --headless -u 100 -r 100 -t 2m --html "reports/${REPORT_PREFIX}.html" --csv "reports/$REPORT_PREFIX"
        ;;
    interactive)
        echo "–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º"
        echo "–û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8089 –≤ –±—Ä–∞—É–∑–µ—Ä–µ"
        echo ""
        echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –ù–∞—á–∏–Ω–∞–π—Ç–µ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π!"
        echo "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—á–∞—Ç—å —Å 5-10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
        echo ""
        locust -f locustfile.py --host=$HOST
        ;;
    *)
        echo "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: $SCENARIO"
        echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏: light, medium, high, stress, spike, interactive"
        exit 1
        ;;
esac

echo ""
echo "=========================================="
echo "–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "=========================================="
echo ""
echo "–û—Ç—á–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ reports/:"
echo "  HTML: reports/${REPORT_PREFIX}.html"
echo "  CSV:  reports/${REPORT_PREFIX}_*.csv"
echo ""
echo "–î–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:"
echo "  python analyze_results.py reports/${REPORT_PREFIX}_stats.csv"
echo ""
echo "‚ö†Ô∏è  –ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã!"
echo ""





