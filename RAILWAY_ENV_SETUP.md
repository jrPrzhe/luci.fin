# Настройка переменных окружения в Railway для ежедневных уведомлений

## Проблемы, которые нужно исправить:

### 1. Telegram - ошибка с web_app кнопкой
**Ошибка:** `Bad Request: inline keyboard button Web App URL 'http://localhost:5173' is invalid: Only HTTPS links are allowed`

**Решение:** Установите правильный `FRONTEND_URL` в Railway

### 2. VK - ошибка с токеном
**Ошибка:** `User authorization failed: no access_token passed`

**Решение:** Убедитесь, что `VK_BOT_TOKEN` установлен в Railway

---

## Шаг 1: Настройка FRONTEND_URL

**ВАЖНО:** После исправления кода, если `FRONTEND_URL` не установлен или невалиден, кнопка web_app не будет добавляться (это предотвратит ошибки). Но для полной функциональности нужно установить правильный URL.

### Установка FRONTEND_URL в Railway:

1. Откройте [Railway Dashboard](https://railway.app)
2. Найдите ваш **Backend Service**
3. Перейдите в **Variables** (или **Settings** → **Variables**)
4. Найдите или создайте переменную `FRONTEND_URL`
5. Установите значение на URL вашего фронтенда:
   ```
   https://luci-fin.vercel.app
   ```
   
   **БЕЗ завершающего слеша!** (не `https://luci-fin.vercel.app/`)

### Что изменилось в коде:

- Теперь кнопка web_app добавляется **только** если:
  - URL начинается с `https://` (для продакшена)
  - ИЛИ URL начинается с `http://localhost` И `DEBUG=True` (только для локальной разработки)
- Если `FRONTEND_URL` не установлен или невалиден, кнопка просто не добавляется (без ошибок)

---

## Шаг 2: Настройка VK_BOT_TOKEN

### Как получить VK Bot Token:

1. Откройте [VK Developers](https://dev.vk.com)
2. Войдите в свой аккаунт
3. Откройте ваше приложение (или создайте новое)
4. Перейдите в **Настройки** → **Работа с API**
5. Создайте ключ доступа (Access Token)
6. **ВАЖНО:** Выберите права доступа:
   - ✅ `messages` - отправка сообщений
   - ✅ `offline` - доступ в любое время
7. Скопируйте созданный токен

### Установка токена в Railway:

1. В Railway Dashboard откройте ваш **Backend Service**
2. Перейдите в **Variables**
3. Найдите или создайте переменную `VK_BOT_TOKEN`
4. Вставьте скопированный токен
5. Сохраните изменения

---

## Шаг 3: Проверка всех переменных

Убедитесь, что в Railway Backend Service установлены:

```env
# Обязательные
DATABASE_URL=postgresql://... (автоматически от Railway)
TELEGRAM_BOT_TOKEN=your-telegram-bot-token
VK_BOT_TOKEN=your-vk-bot-token
FRONTEND_URL=https://luci-fin.vercel.app

# Опциональные (если используете)
GOOGLE_AI_API_KEY=your-google-ai-key
SECRET_KEY=your-secret-key
```

---

## Шаг 4: Перезапуск сервиса

После изменения переменных окружения:

1. Railway автоматически перезапустит сервис
2. Или вручную: **Settings** → **Restart**

---

## Проверка работы

После настройки переменных запустите скрипт снова:

```bash
python scripts/send_daily_reminders.py
```

Теперь должны увидеть:
- ✅ Telegram уведомления отправляются успешно
- ✅ VK уведомления отправляются успешно (если токен правильный)

---

## Если проблемы остаются

### Telegram все еще не работает:

1. Проверьте, что `FRONTEND_URL` начинается с `https://`
2. Проверьте, что URL доступен (откройте в браузере)
3. Проверьте логи в Railway для детальных ошибок

### VK все еще не работает:

1. Проверьте, что токен скопирован полностью (без пробелов)
2. Проверьте права доступа токена (должны быть `messages` и `offline`)
3. Проверьте, что токен не истек
4. Убедитесь, что бот добавлен в сообщество и имеет права на отправку сообщений

---

## Примечания

- Если у вас нет фронтенда или он не развернут, кнопка web_app не будет добавлена (это нормально)
- VK токен должен быть токеном сообщества (Community Token), а не пользовательским токеном
- Telegram токен должен быть токеном бота, созданного через @BotFather


