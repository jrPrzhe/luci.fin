# Логика задач для пользователей

## Обзор системы

В проекте реализована система геймификации с ежедневными задачами (квестами), которые мотивируют пользователей вести учёт финансов. Система автоматически создаёт задачи, отслеживает их выполнение и начисляет награды.

---

## Модели данных

### 1. DailyQuest (Шаблоны задач)
**Таблица**: `daily_quests`

Шаблоны задач, которые используются для создания персональных задач пользователей.

**Поля**:
- `id` - уникальный идентификатор
- `quest_type` - тип задачи (enum: `QuestType`)
- `title` - название задачи
- `description` - описание задачи
- `xp_reward` - награда в XP за выполнение
- `conditions` - условия выполнения (JSON, опционально)
- `is_active` - активна ли задача (можно отключить)
- `created_at`, `updated_at` - временные метки

### 2. UserDailyQuest (Персональные задачи пользователя)
**Таблица**: `user_daily_quests`

Индивидуальные задачи, созданные для конкретного пользователя на конкретную дату.

**Поля**:
- `id` - уникальный идентификатор
- `profile_id` - ссылка на профиль геймификации пользователя
- `quest_id` - ссылка на шаблон задачи (может быть `null` для персональных задач)
- `quest_type` - тип задачи
- `title` - название задачи
- `description` - описание
- `xp_reward` - награда в XP
- `conditions` - условия выполнения (JSON)
- `status` - статус задачи (`pending`, `completed`, `expired`)
- `progress` - прогресс выполнения (0-100)
- `target_value` - целевое значение (опционально)
- `quest_date` - дата задачи (для ежедневных задач)
- `created_at`, `completed_at`, `updated_at` - временные метки

### 3. UserGamificationProfile (Профиль геймификации)
**Таблица**: `user_gamification_profiles`

Профиль пользователя, хранящий всю информацию о геймификации.

**Поля**:
- `user_id` - ссылка на пользователя
- `level` - текущий уровень
- `xp` - текущий опыт
- `streak_days` - количество дней подряд с транзакциями
- `heart_level` - уровень сердца Люси (0-100)
- `total_xp_earned` - всего заработано XP
- `total_quests_completed` - всего выполнено задач

---

## Типы задач (QuestType)

### 1. RECORD_EXPENSE (`record_expense`)
**Описание**: Записать трату  
**Награда**: 10 XP  
**Условие выполнения**: Создать транзакцию типа "expense"  
**Автоматическое выполнение**: ✅ Да (при создании транзакции)

### 2. RECORD_INCOME (`record_income`)
**Описание**: Записать доход  
**Награда**: 15 XP  
**Условие выполнения**: Создать транзакцию типа "income"  
**Автоматическое выполнение**: ✅ Да (при создании транзакции)

### 3. REVIEW_TRANSACTIONS (`review_transactions`)
**Описание**: Просмотреть транзакции за сегодня  
**Награда**: 5 XP  
**Условие выполнения**: Открыть страницу транзакций  
**Автоматическое выполнение**: ❌ Нет (требует ручного вызова API)

### 4. CHECK_BALANCE (`check_balance`)
**Описание**: Посмотреть баланс своих счетов  
**Награда**: 5 XP  
**Условие выполнения**: Открыть главную страницу или страницу счетов  
**Автоматическое выполнение**: ❌ Нет (требует ручного вызова API)

### 5. SAVE_MONEY (`save_money`)
**Описание**: Сэкономить определённую сумму  
**Награда**: Зависит от условий  
**Условие выполнения**: Зависит от условий  
**Автоматическое выполнение**: ❌ Нет (планируется)

### 6. ASK_LUCY (`ask_lucy`)
**Описание**: Спросить Люсю о бюджете  
**Награда**: Зависит от условий  
**Условие выполнения**: Взаимодействие с AI-ассистентом  
**Автоматическое выполнение**: ❌ Нет (планируется)

### 7. CUSTOM (`custom`)
**Описание**: Персональный квест от ИИ  
**Награда**: Зависит от условий  
**Условие выполнения**: Зависит от условий  
**Автоматическое выполнение**: ❌ Нет (планируется)

---

## Статусы задач (QuestStatus)

- **PENDING** (`pending`) - задача ожидает выполнения
- **COMPLETED** (`completed`) - задача выполнена
- **EXPIRED** (`expired`) - задача истекла (не выполнена в срок)

---

## Логика работы системы

### 1. Генерация ежедневных задач

**Функция**: `generate_daily_quests(profile, db, user)`

**Когда вызывается**:
- При запросе статуса геймификации (`GET /api/v1/gamification/status`)
- При запросе списка задач (`GET /api/v1/gamification/quests`)
- При создании транзакции (если задач ещё нет)
- При отправке ежедневных напоминаний

**Логика**:
1. Проверяется, есть ли уже задачи на сегодня для пользователя
2. Если задачи есть, они возвращаются без изменений
3. Если задач нет:
   - Получаются активные шаблоны задач из таблицы `daily_quests`
   - Если шаблонов нет, создаются базовые задачи напрямую:
     - "Запиши трату" (10 XP)
     - "Запиши доход" (15 XP)
   - Если шаблоны есть, создаются персональные задачи из первых 2 активных шаблонов
   - Каждая задача создаётся со статусом `PENDING` и прогрессом 0
   - Задачи привязываются к текущей дате (UTC)

**Особенности**:
- Задачи создаются только один раз в день
- Максимум 2 общих задачи из шаблонов
- Персональные задачи от ИИ пока не реализованы (TODO)

### 2. Автоматическое выполнение задач

**Где происходит**: При создании транзакции (`POST /api/v1/transactions/`)

**Логика**:
1. После создания транзакции проверяется её тип (`expense` или `income`)
2. Если тип соответствует задаче (`record_expense` или `record_income`):
   - Генерируются задачи на сегодня, если их ещё нет
   - Ищется соответствующая задача со статусом `PENDING` на сегодня или на дату транзакции
   - Если задача найдена:
     - Прогресс устанавливается в 100%
     - Статус меняется на `COMPLETED`
     - Устанавливается `completed_at`
     - Начисляется награда (XP) через функцию `add_xp()`
     - Увеличивается счётчик `total_quests_completed`
   - Если задача не найдена, логируется предупреждение

**Важно**: Автоматически выполняются только задачи типа `record_expense` и `record_income`. Остальные требуют ручного вызова API.

### 3. Ручное выполнение задач

**Эндпоинт**: `POST /api/v1/gamification/quests/{quest_id}/complete`

**Логика**:
1. Проверяется, что задача существует и принадлежит пользователю
2. Проверяется, что задача ещё не выполнена
3. Если в запросе указан прогресс, он обновляется (ограничен 0-100)
4. Задача помечается как выполненная:
   - `status` = `COMPLETED`
   - `progress` = 100
   - `completed_at` = текущее время
5. Начисляется награда (XP)
6. Увеличивается счётчик выполненных задач
7. Проверяются достижения (может быть разблокировано новое достижение)

### 4. Начисление наград

**Функция**: `add_xp(profile, amount, db)`

**Логика**:
1. Увеличивается текущий XP пользователя
2. Увеличивается общий заработанный XP
3. Проверяется повышение уровня через `check_level_up()`
4. Увеличивается уровень сердца на 1 (максимум 100)
5. Возвращается информация о результате (был ли уровень ап, новый уровень, новый XP)

**Повышение уровня**:
- Формула: `XP_PER_LEVEL = 100` (линейная прогрессия)
- Необходимый XP для уровня N = N × 100
- При достижении необходимого XP уровень увеличивается, а избыточный XP остаётся

### 5. Отслеживание страйка

**Функция**: `update_streak(profile, transaction_date, db)`

**Логика**:
1. Определяется дата транзакции (нормализуется к UTC)
2. Если это первая транзакция пользователя:
   - Страйк устанавливается в 1 день
   - Сохраняется дата последней транзакции
3. Если транзакция в тот же день:
   - Страйк не изменяется
4. Если транзакция на следующий день:
   - Страйк увеличивается на 1
   - Обновляется дата последней транзакции
5. Если пропущен день:
   - Страйк сбрасывается до 1
   - Уровень сердца уменьшается на 5 (минимум 0)
   - Обновляется дата последней транзакции

**Бонус за страйк**: При создании транзакции, если страйк > 1, начисляется дополнительный XP (`XP_FOR_STREAK = 2`).

### 6. Проверка достижений

**Функция**: `check_achievements(profile, db)`

**Когда вызывается**:
- После выполнения задачи
- После создания транзакции

**Логика**:
1. Получаются все активные достижения
2. Для каждого достижения проверяется, не разблокировано ли оно уже
3. Парсятся условия разблокировки из JSON
4. Проверяются условия в зависимости от типа достижения:
   - `STREAK` - проверяется количество дней подряд
   - `LEVEL` - проверяется текущий уровень
   - `XP` - проверяется общий заработанный XP
   - `HEART` - проверяется уровень сердца
5. Если условия выполнены:
   - Создаётся запись `UserAchievement`
   - Начисляется награда (XP)
   - Достижение добавляется в список новых

---

## API эндпоинты

### 1. GET /api/v1/gamification/status
**Описание**: Получить полный статус геймификации

**Ответ включает**:
- Профиль пользователя (уровень, XP, страйк, сердце)
- Список ежедневных задач на сегодня
- Последние 5 достижений
- XP до следующего уровня

**Особенность**: Автоматически генерирует задачи на сегодня, если их нет.

### 2. GET /api/v1/gamification/quests
**Описание**: Получить список ежедневных задач

**Ответ**: Список задач на сегодня

**Особенность**: Автоматически генерирует задачи на сегодня, если их нет.

### 3. POST /api/v1/gamification/quests/{quest_id}/complete
**Описание**: Выполнить задачу вручную

**Параметры**:
- `quest_id` - ID задачи
- `request` (опционально) - может содержать `progress` (0-100)

**Ответ**: Обновлённая задача

**Использование**: Для задач, которые не выполняются автоматически (`review_transactions`, `check_balance`).

### 4. GET /api/v1/gamification/achievements
**Описание**: Получить все достижения с информацией о разблокировке

**Ответ**: Список всех достижений с флагом `is_unlocked` для каждого.

---

## Интеграция с транзакциями

При создании транзакции (`POST /api/v1/transactions/`) происходит:

1. **Создание транзакции** в базе данных
2. **Создание/обновление профиля геймификации** (если его нет)
3. **Обновление страйка** (проверка последовательности дней)
4. **Начисление XP за транзакцию**:
   - Базовый XP: 5 (`XP_FOR_TRANSACTION`)
   - Бонус за страйк: +2 (`XP_FOR_STREAK`), если страйк > 1
5. **Проверка достижений** (может разблокировать новые)
6. **Генерация задач** на сегодня, если их нет
7. **Автоматическое выполнение задач**:
   - Если транзакция типа "expense" → выполняется задача `record_expense`
   - Если транзакция типа "income" → выполняется задача `record_income`
8. **Начисление награды за выполненную задачу** (дополнительный XP)
9. **Возврат информации о геймификации** в ответе:
   - Был ли уровень ап
   - Новый уровень
   - Новые достижения

---

## Константы геймификации

```python
XP_PER_LEVEL = 100          # XP необходимое для каждого уровня
XP_FOR_TRANSACTION = 5      # XP за транзакцию
XP_FOR_STREAK = 2           # Дополнительный XP за страйк
HEART_DECAY_PER_DAY = 5     # Уменьшение сердца за пропущенный день
HEART_INCREASE_PER_ACTION = 1  # Увеличение сердца за действие
```

---

## Инициализация данных

При первом запуске системы необходимо инициализировать базовые шаблоны задач и достижений.

**Скрипт**: `backend/scripts/init_gamification_data.py`

**Что инициализируется**:

1. **Базовые задачи**:
   - "Запиши трату" (10 XP)
   - "Запиши доход" (15 XP)
   - "Проверь транзакции" (5 XP)
   - "Проверь баланс" (5 XP)

2. **Базовые достижения**:
   - "Первая неделя" - 7 дней подряд (50 XP)
   - "Месяц дисциплины" - 30 дней подряд (200 XP)
   - "Новичок" - 5 уровень (100 XP)
   - "Опытный финансист" - 10 уровень (300 XP)
   - "Дружба с Люсей" - 80 очков сердца (150 XP)
   - "Первая тысяча" - 1000 XP (200 XP)

---

## Планы на будущее

1. **Персональные задачи от ИИ**:
   - Генерация индивидуальных задач на основе финансового поведения пользователя
   - Пример: "Сегодня не покупай кофе — сэкономь 300₽"

2. **Задачи на экономию**:
   - Задачи с целевой суммой экономии
   - Отслеживание прогресса по сумме

3. **Задачи на создание целей**:
   - Мотивация к постановке финансовых целей

4. **Задачи на анализ расходов**:
   - Мотивация к использованию аналитики

5. **Автоматическое истечение задач**:
   - Автоматическая пометка задач как `EXPIRED` в конце дня

---

## Примеры использования

### Пример 1: Автоматическое выполнение задачи при создании транзакции

```python
# Пользователь создаёт транзакцию типа "expense"
POST /api/v1/transactions/
{
    "transaction_type": "expense",
    "amount": 500,
    "account_id": 1,
    ...
}

# Система автоматически:
# 1. Создаёт транзакцию
# 2. Начисляет 5 XP за транзакцию
# 3. Обновляет страйк
# 4. Генерирует задачи на сегодня (если их нет)
# 5. Находит задачу "Запиши трату"
# 6. Помечает её как выполненную
# 7. Начисляет 10 XP за выполнение задачи
# 8. Проверяет достижения
```

### Пример 2: Ручное выполнение задачи

```python
# Пользователь открыл страницу транзакций
# Frontend вызывает API для выполнения задачи
POST /api/v1/gamification/quests/123/complete
{
    "progress": 100
}

# Система:
# 1. Проверяет, что задача существует и не выполнена
# 2. Помечает задачу как выполненную
# 3. Начисляет 5 XP
# 4. Проверяет достижения
```

### Пример 3: Получение статуса геймификации

```python
# Пользователь открывает главную страницу
GET /api/v1/gamification/status

# Система:
# 1. Создаёт профиль геймификации (если его нет)
# 2. Генерирует задачи на сегодня (если их нет)
# 3. Возвращает полный статус:
#    - Уровень, XP, страйк, сердце
#    - Список задач на сегодня
#    - Последние достижения
#    - XP до следующего уровня
```

---

## Важные замечания

1. **Изоляция данных**: Все задачи привязаны к конкретному пользователю через `profile_id`, который связан с `user_id`. Пользователь видит только свои задачи.

2. **Даты и время**: Все даты хранятся в UTC. При генерации задач используется текущая дата UTC.

3. **Идемпотентность**: Генерация задач идемпотентна - если задачи на сегодня уже существуют, новые не создаются.

4. **Обработка ошибок**: Все операции с задачами обёрнуты в try-except блоки с логированием ошибок.

5. **Производительность**: При создании транзакции выполняется несколько операций с БД, но они оптимизированы и выполняются в одной транзакции.

---

## Логирование

Система логирует:
- Генерацию задач для пользователей
- Выполнение задач
- Начисление наград
- Предупреждения (например, если задача не найдена)
- Ошибки при работе с задачами

Логи помогают отслеживать работу системы и отлаживать проблемы.





