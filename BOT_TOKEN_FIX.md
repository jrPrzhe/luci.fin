# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å —Ç–æ–∫–µ–Ω–∞–º–∏ –∏ polling –≤ Telegram –±–æ—Ç–µ

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. –ü—Ä–æ–±–ª–µ–º–∞ —Å –∏—Å—Ç–µ—á–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–æ–≤ JWT

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –¢–æ–∫–µ–Ω—ã JWT –∏—Å—Ç–µ–∫–∞–ª–∏ —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç
- –ë–æ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–ª —Ç–æ–∫–µ–Ω—ã, –Ω–æ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª –∏—Ö —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
- –ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç –ø–µ—Ä–µ—Å—Ç–∞–≤–∞–ª —Ä–∞–±–æ—Ç–∞—Ç—å —Å –æ—à–∏–±–∫–æ–π "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `is_token_expired()` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞
- ‚úÖ –¢–æ–∫–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º (—Å –±—É—Ñ–µ—Ä–æ–º 5 –º–∏–Ω—É—Ç –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ 401 (Unauthorized) —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–∞ –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞

### 2. –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏ getUpdates

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ë–æ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–ª –∑–∞–ø—Ä–æ—Å—ã `getUpdates` –∫–∞–∂–¥—ã–µ ~10 —Å–µ–∫—É–Ω–¥
- –≠—Ç–æ —Å–æ–∑–¥–∞–≤–∞–ª–æ –º–Ω–æ–≥–æ –ª–æ–≥–æ–≤ –∏ –º–æ–≥–ª–æ –ø–æ–∫–∞–∑–∞—Ç—å—Å—è "–Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏"

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω –∏–Ω—Ç–µ—Ä–≤–∞–ª polling –¥–æ 2 —Å–µ–∫—É–Ω–¥ (`poll_interval=2.0`)
- ‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è polling —Ä–µ–∂–∏–º–∞ - –±–æ—Ç –¥–æ–ª–∂–µ–Ω –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –æ–ø—Ä–∞—à–∏–≤–∞—Ç—å Telegram API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

## üîç –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞

```python
def is_token_expired(token: str) -> bool:
    """Check if JWT token is expired"""
    # –î–µ–∫–æ–¥–∏—Ä—É–µ—Ç JWT payload
    # –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–ª–µ 'exp' (expiration time)
    # –î–æ–±–∞–≤–ª—è–µ—Ç –±—É—Ñ–µ—Ä 5 –º–∏–Ω—É—Ç - –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –µ—Å–ª–∏ –æ–Ω –∏—Å—Ç–µ–∫–∞–µ—Ç –º–µ–Ω–µ–µ —á–µ–º —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞

```python
async def get_user_token(telegram_id: str, force_refresh: bool = False) -> str:
    """Get or refresh user token with expiration check"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω
    # –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫ –∏–ª–∏ –∏—Å—Ç–µ–∫–∞–µ—Ç —Å–∫–æ—Ä–æ - –ø–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤—ã–π
    # –ö—ç—à–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
```

### –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤

```python
async def make_authenticated_request(
    method: str,
    url: str,
    telegram_id: str,
    json_data: Optional[dict] = None,
    params: Optional[dict] = None,
    timeout: float = 5.0,
    retry_on_401: bool = True
) -> httpx.Response:
    """
    Make an authenticated HTTP request with automatic token refresh on 401
    
    - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω
    - –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ 401 –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å
    - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ HTTP –º–µ—Ç–æ–¥—ã (GET, POST, PUT, DELETE, PATCH)
    """
```

## üìä –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–æ—Ç–∞ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç `make_authenticated_request()` –≤–º–µ—Å—Ç–æ –ø—Ä—è–º—ã—Ö –≤—ã–∑–æ–≤–æ–≤ API:

- ‚úÖ `get_balance()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
- ‚úÖ `get_transactions()` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- ‚úÖ `add_expense_start()` - –Ω–∞—á–∞–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞
- ‚úÖ `add_income_start()` - –Ω–∞—á–∞–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ—Ö–æ–¥–∞
- ‚úÖ `description_received()` - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- ‚úÖ `report_command()` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
- ‚úÖ `goal_info_received()` - —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Ü–µ–ª–∏
- ‚úÖ `goal_confirmation_handler()` - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ü–µ–ª–∏

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚ùå –ë–æ—Ç –ø–µ—Ä–µ—Å—Ç–∞–≤–∞–ª —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç
- ‚ùå –û—à–∏–±–∫–∞ "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ" –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
- ‚ùå –ú–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ getUpdates –≤ –ª–æ–≥–∞—Ö

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ –±–µ–∑ –ø–µ—Ä–µ—Ä—ã–≤–æ–≤
- ‚úÖ –¢–æ–∫–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø–µ—Ä–µ–¥ –∏—Å—Ç–µ—á–µ–Ω–∏–µ–º
- ‚úÖ –û—à–∏–±–∫–∏ 401 –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ò–Ω—Ç–µ—Ä–≤–∞–ª polling –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω (2 —Å–µ–∫—É–Ω–¥—ã –≤–º–µ—Å—Ç–æ ~10)

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### Polling —Ä–µ–∂–∏–º

**–ó–∞–ø—Ä–æ—Å—ã `getUpdates` - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ!**

Polling —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫:
1. –ë–æ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç Telegram API —á–µ—Ä–µ–∑ `getUpdates`
2. –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
3. –ë–µ–∑ —ç—Ç–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –±–æ—Ç –Ω–µ —Å–º–æ–∂–µ—Ç –ø–æ–ª—É—á–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:** Webhook —Ä–µ–∂–∏–º (–Ω–æ —Ç—Ä–µ–±—É–µ—Ç HTTPS –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)

### –ò–Ω—Ç–µ—Ä–≤–∞–ª polling

- **–¢–µ–∫—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª:** 2 —Å–µ–∫—É–Ω–¥—ã
- **–ú–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å:** –¥–æ 5-10 —Å–µ–∫—É–Ω–¥ –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏
- **–ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:** –±–æ–ª–µ–µ 10 —Å–µ–∫—É–Ω–¥ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±—É–¥—É—Ç –∑–∞–º–µ—á–∞—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏

## üîÑ –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ

1. **–î–µ–ø–ª–æ–π –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
   ```bash
   git add telegram-bot/bot.py
   git commit -m "Fix token expiration and optimize polling"
   git push origin main
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞:**
   - –ë–æ—Ç –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ –±–µ–∑ –æ—à–∏–±–æ–∫
   - –¢–æ–∫–µ–Ω—ã –¥–æ–ª–∂–Ω—ã –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–µ–Ω—å—à–µ –æ—à–∏–±–æ–∫ 401

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Railway —á–µ—Ä–µ–∑ 30+ –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
   - –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –Ω–µ—Ç –æ—à–∏–±–æ–∫ "ExpiredSignatureError"
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—ã

---

**–í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –¥–µ–ø–ª–æ—é!** üöÄ








