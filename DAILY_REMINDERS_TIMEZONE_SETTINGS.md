# Настройка ежедневных уведомлений с учетом часового пояса

## Что было реализовано

### 1. Учет часового пояса пользователя
- Уведомления отправляются в **9:00 утра по местному времени** каждого пользователя
- Используется поле `timezone` из профиля пользователя (по умолчанию UTC)
- Если часовой пояс не указан или невалиден, используется UTC

### 2. Настройки уведомлений
- Добавлены поля `telegram_notifications_enabled` и `vk_notifications_enabled` в модель User
- По умолчанию уведомления **включены** для всех пользователей
- Пользователи могут отключать уведомления отдельно для Telegram и VKontakte

### 3. API для управления настройками
- Обновлен endpoint `PUT /api/v1/auth/me` для управления настройками уведомлений
- Можно обновить через API:
  ```json
  {
    "telegram_notifications_enabled": false,
    "vk_notifications_enabled": true
  }
  ```

## Миграция базы данных

Выполните миграцию для добавления новых полей:

```bash
cd backend
python -m alembic upgrade head
```

Миграция: `9b5ae8cad80b_add_notification_settings_to_users`

## Настройка расписания отправки

**Важно:** Скрипт должен запускаться **каждый час**, чтобы не пропустить 9:00 для пользователей в разных часовых поясах.

### Railway Scheduler

Настройте в Railway Scheduler запуск скрипта каждый час:

```
0 * * * * python scripts/send_daily_reminders.py
```

Или через интерфейс Railway:
1. Откройте **Scheduler** в вашем проекте
2. Создайте новое задание
3. Установите расписание: `0 * * * *` (каждый час в 0 минут)
4. Команда: `python scripts/send_daily_reminders.py`

### Логика работы

1. Скрипт запускается каждый час
2. Для каждого пользователя проверяется:
   - Активен ли пользователь
   - Есть ли у него Telegram или VK ID
   - **Наступило ли 9:00 по его часовому поясу**
   - Включены ли уведомления для соответствующей платформы
3. Если все условия выполнены - отправляется уведомление

## Примеры часовых поясов

Пользователи могут установить свой часовой пояс через API или профиль:

- `Europe/Moscow` - Москва (UTC+3)
- `America/New_York` - Нью-Йорк (UTC-5)
- `Asia/Tokyo` - Токио (UTC+9)
- `Europe/London` - Лондон (UTC+0)
- `UTC` - UTC (по умолчанию)

Полный список доступных часовых поясов: https://en.wikipedia.org/wiki/List_of_tz_database_time_zones

## Обновление фронтенда

Для управления настройками уведомлений на фронтенде нужно:

1. Добавить поля в форму профиля:
   - `telegram_notifications_enabled` (checkbox)
   - `vk_notifications_enabled` (checkbox)

2. При обновлении профиля отправлять эти поля в API:
   ```typescript
   await api.updateUser({
     telegram_notifications_enabled: true,
     vk_notifications_enabled: false
   })
   ```

## Проверка работы

После деплоя проверьте:

1. Убедитесь, что миграция выполнена успешно
2. Проверьте, что скрипт запускается каждый час
3. Проверьте логи - должны видеть сообщения о проверке времени для каждого пользователя
4. Убедитесь, что уведомления отправляются только в 9:00 по местному времени

## Отладка

В логах вы увидите:
- `[INFO] Skipped X users (not 9:00 in their timezone)` - пользователи, у которых еще не 9:00
- `[INFO] Telegram notifications disabled for user X, skipping` - уведомления отключены
- `[SUCCESS] Telegram reminder sent to user X` - уведомление отправлено

